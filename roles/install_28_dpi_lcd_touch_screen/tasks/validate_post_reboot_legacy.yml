---
- name: Check framebuffer fb0 exists (legacy path)
  stat:
    path: /sys/class/graphics/fb0
  register: fb0
  changed_when: false

- name: Assert fb0 exists (legacy)
  assert:
    that: fb0.stat.exists
    fail_msg: "Brak /sys/class/graphics/fb0 po legacy DPI konfiguracji."

- name: Warn no DRM DPI-1 expected on legacy
  shell: "ls /sys/class/drm/*-DPI-1 2>/dev/null || true"
  register: drm_dpi
  changed_when: false

- debug:
    msg: "Legacy fallback: DRM DPI-1 może nie istnieć (to normalne). Output: {{ drm_dpi.stdout | default('') }}"

# I2C / Goodix check (jak poprzednio)
- name: Check I2C bus for Goodix touch (0x14 or 0x5d)
  shell: |
    set -euo pipefail
    if command -v i2cdetect >/dev/null; then
      mapfile -t busses < <(i2cdetect -l | awk '{print $1}' | sed 's/i2c-//g')
      found=0
      for b in "${busses[@]}"; do
        if i2cdetect -y "$b" | grep -qE '\b14\b|\b5d\b'; then
          echo "Goodix likely present on bus $b"
          found=1
        fi
      done
      [[ $found -eq 1 ]] || echo "Goodix not detected on any bus"
    else
      echo "i2cdetect not available"
    fi
  register: i2c_check
  changed_when: false

- debug:
    var: i2c_check.stdout

- name: Grep dmesg for Goodix driver bind
  shell: dmesg | grep -i goodix | tail -n 20 || true
  register: dmesg_goodix
  changed_when: false

- debug:
    var: dmesg_goodix.stdout_lines
