#!/usr/bin/env bash
set -euo pipefail

if [[ "${EUID}" -ne 0 ]]; then
    echo "❌ Ten skrypt musi być uruchomiony jako root (np. przez: sudo $0)" >&2
    exit 1
fi

REAL_USER="${SUDO_USER:-$USER}"

echo -e "\e[32m✔\e[0m Skrypt uruchomiony z uprawnieniami root."

REQUIRED_PACKAGES=(
    git
    python3-venv
    python3-pip
)

echo -n "> Sprawdzanie wymaganych pakietów"
install_packages=""

for package_name in "${REQUIRED_PACKAGES[@]}"; do
    if dpkg -s "${package_name}" &> /dev/null; then
        echo -n "."
    else
        install_packages="${package_name}"
    fi
done

if [ -n "${install_packages}" ]; then
    sudo apt-get update -y
    sudo apt-get install -y ${install_packages}
    sudo apt autoremove -y
fi
echo -e "\n\e[32m✔\e[0m Wszystkie wymagane pakiety są już zainstalowane."

venv_path="/home/${REAL_USER}/.venv"

if [[ ! -d "${venv_path}" ]]; then
    echo "> Tworzenie wirtualnego środowiska w ${venv_path} ..."
    cd /home/${REAL_USER}
    python3 -m venv .venv
    source ${venv_path}/bin/activate
    pip install ansible
    echo -e "\e[32m✔\e[0m Wirtualne środowisko zostało utworzone."
fi

if ! grep -Fxq "alias rpi-update-client='sudo /home/${REAL_USER}/ansible_rpi/rpi-update-client'" /home/${REAL_USER}/.bashrc; then
    echo "alias rpi-update-client='sudo /home/${REAL_USER}/ansible_rpi/rpi-update-client'" >> /home/${REAL_USER}/.bashrc
fi

source /home/${REAL_USER}/.venv/bin/activate
echo -e "\e[32m✔\e[0m Wczytano wirtualne środowisko z ${venv_path}"
cd /home/${REAL_USER}/ansible_rpi || exit 2
echo "> Aktualizuję repozytorium i uruchamiam aktualizację..."
git pull && ansible-playbook -i inventory.ini playbook.yml && echo -e "\e[32m✔\e[0m  Aktualizacja zakończona."
